<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cylinder 3D - Full Port</title>
    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            touch-action: none; /* デフォルトのスクロールを無効化 */
            font-family: sans-serif;
        }
        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            /* setEntry(3, 2, -0.0005) に相当する遠近感 */
            perspective: 2000px; 
        }
        #cylinder-root {
            position: relative;
            transform-style: preserve-3d;
            /* scale(0.6) rotateX(-22deg) を再現 */
            transform: scale(0.6) rotateX(-22deg);
            width: 275px; 
            height: 355px;
        }
        .panel {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform-style: preserve-3d;
            backface-visibility: visible;
        }
        /* 画像を裸で置くためのスタイル */
        .card-img {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: fill;
            pointer-events: none;
        }
        .zebra {
            /* scaleX(-1.0) を再現 */
            transform: scaleX(-1);
        }
        #page-indicator {
            position: fixed;
            top: 30px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
        }
    </style>
</head>
<body>

<div id="page-indicator">Index: 0</div>
<div id="container">
    <div id="cylinder-root"></div>
</div>

<script>
    // --- 設定値 (Assets) ---
    const panelImages = [
        'assets/2queen_b.webp', 
        'assets/2king_b.webp', 
        'assets/2jack_b.webp', 
        'assets/2joker1_b.webp', 
        'assets/2joker2_b.webp'
    ];
    const backImage = 'assets/2zebra_b.webp';

    // --- 定数 ---
    const totalPanelCount = 6;
    const stepAngle = 360 / totalPanelCount;
    const cylinderZ = 300; // baseWidth * (300/390) 相当

    // --- 状態管理 ---
    let angle = 0.0;
    let mode = 2; // 2:加速, 3:減速, 4:停止制御, 5:終了
    let currentSpeed = 0.5;
    let dragSpeed = 0.0;
    let isTouching = false;
    let isLongPressing = false;
    let startTime = null;
    let targetAngle = null;
    let lastReportedSeat = -1;
    let totalStepCount = 0;
    let currentIndex = 0;

    const root = document.getElementById('cylinder-root');
    const indicator = document.getElementById('page-indicator');

    // パネル要素（div）の生成
    const panels = [];
    for (let i = 0; i < totalPanelCount; i++) {
        const el = document.createElement('div');
        el.className = 'panel';
        root.appendChild(el);
        panels.push(el);
    }

    /**
     * 更新ロジック (_update)
     */
    function update() {
        if (mode === 5) return;

        // ドラッグ速度の減衰
        dragSpeed *= 0.95;
        angle += (currentSpeed + dragSpeed);

        // インデックス報告ロジック
        const currentSeat = Math.round(angle / stepAngle);
        if (lastReportedSeat !== currentSeat) {
            let diff = currentSeat - lastReportedSeat;
            if (lastReportedSeat !== -1) {
                totalStepCount += diff;
            } else {
                totalStepCount = currentSeat;
            }
            lastReportedSeat = currentSeat;
            
            let visualIndex = totalStepCount % 5;
            if (visualIndex < 0) visualIndex += 5;
            if (currentIndex !== visualIndex) {
                currentIndex = visualIndex;
                indicator.innerText = `Index: ${currentIndex}`;
            }
        }

        const now = Date.now();

        // モード遷移・物理演算
        if (mode === 2) {
            let target = 0.5;
            if (startTime) {
                const elapsed = now - startTime;
                if (elapsed < 20000) {
                    target = 0.5 + (elapsed / 1000);
                } else {
                    mode = 3;
                }
            } else if (isLongPressing || isTouching) {
                target = 4.0;
            }
            currentSpeed += (target - currentSpeed) * 0.05;
        } 
        else if (mode === 3) {
            currentSpeed *= 0.98;
            if (currentSpeed < 1.2) {
                mode = 4;
                targetAngle = Math.round(angle / stepAngle) * stepAngle;
            }
        } 
        else if (mode === 4) {
            let distance = targetAngle - angle;
            currentSpeed = (currentSpeed * 0.92) + distance * 0.04;

            if (Math.abs(distance) < 0.01 && Math.abs(currentSpeed) < 0.01) {
                angle = targetAngle;
                mode = 5;
                console.log("Animation Finished");
                // 5秒後に次へ（FlutterのonFinished）
                setTimeout(() => {
                    alert("Next Chapter!"); 
                }, 5000);
            }
        }

        render();
        requestAnimationFrame(update);
    }

    /**
     * 描画ロジック (_buildPanel)
     */
    function render() {
        panels.forEach((panel, i) => {
            const rad = (i * stepAngle + angle) * Math.PI / 180;
            const z = Math.cos(rad);

            // インデックスとクロスフェードの計算
            const rawTurns = (rad * 180 / Math.PI + 100) / 360;
            const currentTurns = Math.floor(rawTurns);
            
            let currentIdx = (i - currentTurns) % 5;
            if (currentIdx < 0) currentIdx += 5;
            let nextIdx = (i - (currentTurns + 1)) % 5;
            if (nextIdx < 0) nextIdx += 5;

            const progress = rawTurns - currentTurns;
            const fadeValue = Math.min(Math.max((progress - 0.5) / 0.5, 0.0), 1.0);
            const frontOpacity = Math.min(Math.max((z * 8) + 0.5, 0.0), 1.0);
            const brightness = Math.min(Math.max((z + 1.2) / 2.2, 0.2), 1.0);

            // 3Dトランスフォーム適用
            panel.style.transform = `rotateY(${rad}rad) translateZ(${cylinderZ}px) rotateX(1deg)`;
            
            // 画像を「裸」で重ねる構造を再現
            panel.innerHTML = `
                <img src="${backImage}" class="card-img zebra">
                
                <div style="position:absolute; width:100%; height:100%; opacity: ${frontOpacity}; filter: brightness(${brightness});">
                    <img src="${panelImages[currentIdx]}" class="card-img" style="opacity: ${1 - fadeValue};">
                    <img src="${panelImages[nextIdx]}" class="card-img" style="opacity: ${fadeValue};">
                </div>
            `;
        });
    }

    // --- インタラクション ---

    // ドラッグ・タッチ開始
    function onStart(e) {
        if (mode >= 4) return;
        isTouching = true;
        isLongPressing = true;
        this.lastX = e.clientX || e.touches[0].clientX;
    }

    // ドラッグ・タッチ移動
    function onMove(e) {
        if (!isTouching || mode >= 4) return;
        const x = e.clientX || e.touches[0].clientX;
        const dx = x - (this.lastX || x);
        this.lastX = x;

        angle += dx * 0.4;
        dragSpeed = dx * 0.4;
    }

    // ドラッグ・タッチ終了
    function onEnd() {
        isTouching = false;
        isLongPressing = false;
        this.lastX = null;
    }

    // イベント登録
    window.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);
    window.addEventListener('touchstart', onStart, {passive: false});
    window.addEventListener('touchmove', onMove, {passive: false});
    window.addEventListener('touchend', onEnd);

    // 自動開始タイマー (10秒後)
    setTimeout(() => {
        if (mode === 2 && !startTime) {
            startTime = Date.now();
            console.log("Auto-start accelerated");
        }
    }, 10000);

    // ループ開始
    update();
</script>

</body>
</html>
